# üë• M√≥dulo de Usuarios

> **üè† [README Principal](../README.md)** | **üìö [Documentaci√≥n General](./README.md)** | **üîê [Autenticaci√≥n](./auth.md)** | **üõí [Productos](./products.md)**

El m√≥dulo de usuarios gestiona las operaciones CRUD de usuarios, perfiles, b√∫squeda y gesti√≥n de roles del sistema.

## üìã Tabla de Contenidos

### üéØ Navegaci√≥n R√°pida
| Secci√≥n | Descripci√≥n |
|---------|-------------|
| **üì° Endpoints P√∫blicos** | Perfil de usuario autenticado |
| **üì° Endpoints Administrativos** | CRUD y gesti√≥n de usuarios (Admin/Superadmin) |
| **üîê Control de Acceso** | Roles y permisos requeridos |
| **üí° Mejores Pr√°cticas** | Recomendaciones de uso |
| **üõ†Ô∏è Ejemplos de Implementaci√≥n** | C√≥digo de ejemplo |

### üìñ Contenido Detallado
- [Endpoints P√∫blicos](#endpoints-p√∫blicos)
  - [üë§ GET /users/profile](#-get-usersprofile) - Obtener perfil del usuario
- [Endpoints Administrativos](#endpoints-administrativos)
  - [üë• GET /users](#-get-users) - Listar todos los usuarios
  - [üîç GET /users/:id](#-get-usersid) - Obtener usuario por ID
  - [üîé GET /users/search/:term](#-get-userssearchterm) - Buscar usuarios
  - [‚úèÔ∏è PUT /users/:id](#Ô∏è-put-usersid) - Actualizar usuario
  - [üîê PUT /users/:id/role](#-put-usersidrole) - Asignar rol a usuario
  - [üóëÔ∏è DELETE /users/:id](#-delete-usersid) - Eliminar usuario
- [Control de Acceso](#control-de-acceso)
- [Mejores Pr√°cticas](#mejores-pr√°cticas)
- [Ejemplos de Implementaci√≥n](#ejemplos-de-implementaci√≥n)

---

<a name="endpoints-p√∫blicos"></a>
## üì° Endpoints P√∫blicos

<a name="-get-usersprofile"></a>
### üë§ GET /users/profile
Obtiene el perfil del usuario autenticado.

**Descripci√≥n**: Devuelve la informaci√≥n completa del usuario actualmente autenticado.

**Autenticaci√≥n**: Requiere token JWT v√°lido

**Headers**:
```
Authorization: Bearer <token_jwt>
```

**Response Exitoso (200)**:
```json
{
  "message": "Perfil del usuario obtenido exitosamente",
  "data": {
    "id": "uuid-del-usuario",
    "firstName": "Juan",
    "lastName": "P√©rez",
    "email": "juan.perez@example.com",
    "phone": "+1234567890",
    "role": "cliente",
    "isActive": true,
    "createdAt": "2024-01-01T00:00:00.000Z",
    "updatedAt": "2024-01-01T00:00:00.000Z"
  },
  "success": true
}
```

**Errores**:
- `400 Bad Request`: Token inv√°lido o mal formado
- `401 Unauthorized`: Token de autorizaci√≥n inv√°lido
- `404 Not Found`: Usuario no encontrado

---

### üë• GET /users
Obtiene todos los usuarios del sistema (solo ADMIN o SUPERADMIN).

**Descripci√≥n**: Devuelve una lista paginada de todos los usuarios registrados en el sistema.

**Autenticaci√≥n**: Requiere token JWT v√°lido y rol ADMIN o SUPERADMIN

**Headers**:
```
Authorization: Bearer <token_jwt>
```

**Query Parameters**:
- `limit`: N√∫mero m√°ximo de usuarios a devolver (default: 10, m√°ximo: 100)
- `offset`: N√∫mero de usuarios a omitir para paginaci√≥n (default: 0)

**Response Exitoso (200)**:
```json
{
  "message": "Lista de usuarios obtenida exitosamente",
  "data": [
    {
      "id": "uuid-del-usuario-1",
      "firstName": "Juan",
      "lastName": "P√©rez",
      "email": "juan.perez@example.com",
      "phone": "+1234567890",
      "role": "cliente",
      "isActive": true,
      "createdAt": "2024-01-01T00:00:00.000Z",
      "updatedAt": "2024-01-01T00:00:00.000Z"
    },
    {
      "id": "uuid-del-usuario-2",
      "firstName": "Mar√≠a",
      "lastName": "Garc√≠a",
      "email": "maria.garcia@example.com",
      "phone": "+0987654321",
      "role": "admin",
      "isActive": true,
      "createdAt": "2024-01-02T00:00:00.000Z",
      "updatedAt": "2024-01-02T00:00:00.000Z"
    }
  ],
  "success": true
}
```

**Errores**:
- `401 Unauthorized`: Token de autorizaci√≥n inv√°lido
- `403 Forbidden`: No tiene permisos para ver usuarios

---

### üîç GET /users/:id
Obtiene un usuario espec√≠fico por ID.

**Descripci√≥n**: Devuelve la informaci√≥n de un usuario espec√≠fico. Los usuarios solo pueden ver su propio perfil, a menos que sean ADMIN o SUPERADMIN.

**Autenticaci√≥n**: Requiere token JWT v√°lido

**Headers**:
```
Authorization: Bearer <token_jwt>
```

**Path Parameters**:
- `id`: ID del usuario a consultar (UUID)

**Response Exitoso (200)**:
```json
{
  "message": "Usuario encontrado exitosamente",
  "data": {
    "id": "uuid-del-usuario",
    "firstName": "Juan",
    "lastName": "P√©rez",
    "email": "juan.perez@example.com",
    "phone": "+1234567890",
    "role": "cliente",
    "isActive": true,
    "createdAt": "2024-01-01T00:00:00.000Z",
    "updatedAt": "2024-01-01T00:00:00.000Z"
  },
  "success": true
}
```

**Errores**:
- `401 Unauthorized`: Token de autorizaci√≥n inv√°lido
- `403 Forbidden`: No autorizado para ver este perfil
- `404 Not Found`: Usuario no encontrado

---

### üîé GET /users/search/:term
Busca usuarios por t√©rmino (solo ADMIN o SUPERADMIN).

**Descripci√≥n**: Busca usuarios por nombre, apellido o email que coincidan con el t√©rmino proporcionado.

**Autenticaci√≥n**: Requiere token JWT v√°lido y rol ADMIN o SUPERADMIN

**Headers**:
```
Authorization: Bearer <token_jwt>
```

**Path Parameters**:
- `term`: T√©rmino de b√∫squeda (string)

**Query Parameters**:
- `limit`: N√∫mero m√°ximo de resultados a devolver (default: 10, m√°ximo: 100)
- `offset`: N√∫mero de resultados a omitir para paginaci√≥n (default: 0)

**Response Exitoso (200)**:
```json
{
  "message": "B√∫squeda de usuarios completada exitosamente",
  "data": [
    {
      "id": "uuid-del-usuario-1",
      "firstName": "Juan",
      "lastName": "P√©rez",
      "email": "juan.perez@example.com",
      "phone": "+1234567890",
      "role": "cliente",
      "isActive": true,
      "createdAt": "2024-01-01T00:00:00.000Z",
      "updatedAt": "2024-01-01T00:00:00.000Z"
    }
  ],
  "success": true
}
```

**Errores**:
- `401 Unauthorized`: Token de autorizaci√≥n inv√°lido
- `403 Forbidden`: No tiene permisos para buscar usuarios

---

### ‚úèÔ∏è PUT /users/:id
Actualiza un usuario existente (solo ADMIN o SUPERADMIN).

**Descripci√≥n**: Actualiza la informaci√≥n de un usuario espec√≠fico. Solo los usuarios con rol ADMIN o SUPERADMIN pueden realizar esta operaci√≥n.

**Autenticaci√≥n**: Requiere token JWT v√°lido y rol ADMIN o SUPERADMIN

**Headers**:
```
Authorization: Bearer <token_jwt>
```

**Path Parameters**:
- `id`: ID del usuario a actualizar (UUID)

**Request Body**:
```json
{
  "firstName": "Juan Carlos",
  "lastName": "P√©rez L√≥pez",
  "email": "juan.carlos@example.com",
  "password": "nuevaPassword123",
  "phone": "+1234567890",
  "role": "admin",
  "isActive": true
}
```

**Campos Opcionales**:
- `firstName`: Nombre del usuario (string, opcional)
- `lastName`: Apellido del usuario (string, opcional)
- `email`: Email del usuario (string, opcional, formato email)
- `password`: Contrase√±a del usuario (string, opcional, m√≠nimo 6 caracteres)
- `phone`: Tel√©fono del usuario (string, opcional)
- `role`: Rol del usuario (enum: `superadmin`, `admin`, `cliente`, opcional)
- `isActive`: Estado de activaci√≥n del usuario (boolean, opcional)

**Response Exitoso (200)**:
```json
{
  "message": "Usuario actualizado exitosamente",
  "data": {
    "id": "uuid-del-usuario",
    "firstName": "Juan Carlos",
    "lastName": "P√©rez L√≥pez",
    "email": "juan.carlos@example.com",
    "phone": "+1234567890",
    "role": "admin",
    "isActive": true,
    "createdAt": "2024-01-01T00:00:00.000Z",
    "updatedAt": "2024-01-01T15:30:00.000Z"
  },
  "success": true
}
```

**Errores**:
- `401 Unauthorized`: Token de autorizaci√≥n inv√°lido
- `403 Forbidden`: No tiene permisos para actualizar usuarios
- `404 Not Found`: Usuario no encontrado

---

### üîê PUT /users/:id/role
Asigna o cambia el rol de un usuario (solo ADMIN o SUPERADMIN).

**Descripci√≥n**: üîí Permite asignar o cambiar el rol de un usuario espec√≠fico. Este endpoint incluye validaciones de seguridad adicionales para prevenir asignaciones no autorizadas. Solo los usuarios con rol ADMIN o SUPERADMIN pueden realizar esta operaci√≥n.

**Autenticaci√≥n**: Requiere token JWT v√°lido y rol ADMIN o SUPERADMIN

**Headers**:
```
Authorization: Bearer <token_jwt>
```

**Path Parameters**:
- `id`: ID del usuario a modificar (UUID)

**Request Body**:
```json
{
  "role": "admin",
  "reason": "Promoci√≥n a administrador del sistema"
}
```

**Campos Obligatorios**:
- `role`: Nuevo rol a asignar (enum: `superadmin`, `admin`, `cliente`)

**Campos Opcionales**:
- `reason`: Motivo del cambio de rol (string, opcional, para auditor√≠a)

**Response Exitoso (200)**:
```json
{
  "message": "Rol asignado exitosamente",
  "data": {
    "userId": "uuid-del-usuario",
    "previousRole": "cliente",
    "newRole": "admin",
    "assignedBy": "admin@example.com",
    "reason": "Promoci√≥n a administrador del sistema"
  },
  "success": true
}
```

**Errores**:
- `400 Bad Request`: Datos inv√°lidos o rol no permitido
- `401 Unauthorized`: Token de autorizaci√≥n inv√°lido
- `403 Forbidden`: No tiene permisos para asignar roles o intento de asignaci√≥n no autorizada
- `404 Not Found`: Usuario no encontrado

**Restricciones de Seguridad**:
- Los usuarios con rol `ADMIN` no pueden asignar el rol `SUPERADMIN`
- Solo los usuarios con rol `SUPERADMIN` pueden modificar el rol de otro `SUPERADMIN`
- Todas las asignaciones de roles son auditadas

---

### üóëÔ∏è DELETE /users/:id
Elimina un usuario existente (solo ADMIN o SUPERADMIN).

**Descripci√≥n**: Elimina permanentemente un usuario del sistema. Solo los usuarios con rol ADMIN o SUPERADMIN pueden realizar esta operaci√≥n.

**Autenticaci√≥n**: Requiere token JWT v√°lido y rol ADMIN o SUPERADMIN

**Headers**:
```
Authorization: Bearer <token_jwt>
```

**Path Parameters**:
- `id`: ID del usuario a eliminar (UUID)

**Response Exitoso (200)**:
```json
{
  "message": "Usuario eliminado exitosamente",
  "success": true
}
```

**Errores**:
- `401 Unauthorized`: Token de autorizaci√≥n inv√°lido
- `403 Forbidden`: No tiene permisos para eliminar usuarios
- `404 Not Found`: Usuario no encontrado

---

## Roles y Permisos

### Jerarqu√≠a de Roles

1. **SUPERADMIN**
   - Acceso completo a todos los endpoints
   - Puede gestionar todos los usuarios
   - Puede asignar cualquier rol
   - Acceso a todas las funcionalidades del sistema

2. **ADMIN**
   - Puede ver y gestionar usuarios (excepto SUPERADMIN)
   - Puede buscar usuarios
   - Puede actualizar y eliminar usuarios (excepto SUPERADMIN)
   - Acceso limitado a funcionalidades administrativas

3. **CLIENTE**
   - Solo puede ver su propio perfil
   - No puede acceder a endpoints de gesti√≥n de usuarios
   - Acceso b√°sico a funcionalidades de cliente

### Matriz de Permisos

| Endpoint | SUPERADMIN | ADMIN | CLIENTE |
|----------|------------|-------|---------|
| GET /users/profile | ‚úÖ | ‚úÖ | ‚úÖ |
| GET /users | ‚úÖ | ‚úÖ | ‚ùå |
| GET /users/:id | ‚úÖ | ‚úÖ | ‚úÖ* |
| GET /users/search/:term | ‚úÖ | ‚úÖ | ‚ùå |
| PUT /users/:id | ‚úÖ | ‚úÖ* | ‚ùå |
| DELETE /users/:id | ‚úÖ | ‚úÖ* | ‚ùå |

*Los CLIENTE solo pueden ver su propio perfil (`/users/:id` donde `:id` es su propio ID)
*Los ADMIN no pueden gestionar usuarios con rol SUPERADMIN

## DTOs y Validaciones

### UpdateUserDto

```typescript
export class UpdateUserDto {
  @IsOptional()
  @IsString()
  firstName?: string;

  @IsOptional()
  @IsString()
  lastName?: string;

  @IsOptional()
  @IsEmail()
  email?: string;

  @IsOptional()
  @IsString()
  @MinLength(6)
  password?: string;

  @IsOptional()
  @IsString()
  phone?: string;

  @IsOptional()
  @IsEnum(UserRole)
  role?: UserRole;

  @IsOptional()
  @IsBoolean()
  isActive?: boolean;
}
```

### User Entity

```typescript
export class User {
  id: string;                    // UUID
  firstName: string;             // Nombre del usuario
  lastName: string;              // Apellido del usuario
  email: string;                 // Email √∫nico
  password: string;              // Contrase√±a hasheada
  phone?: string;                // Tel√©fono opcional
  role: UserRole;                // Rol del usuario
  isActive: boolean;             // Estado de activaci√≥n
  createdAt: Date;               // Fecha de creaci√≥n
  updatedAt: Date;               // Fecha de actualizaci√≥n
}
```

## Mejores Pr√°cticas

### Para Clientes

1. **Manejo de Perfiles**:
   - Almacenar la informaci√≥n del perfil localmente para reducir solicitudes
   - Implementar cach√© para datos de usuario que no cambian frecuentemente

2. **Actualizaciones**:
   - Validar datos antes de enviar al servidor
   - Implementar confirmaci√≥n para acciones destructivas (eliminaci√≥n)

3. **Seguridad**:
   - Nunca exponer contrase√±as en logs o consola
   - Validar permisos en el frontend antes de mostrar opciones

### Para Administradores

1. **Gesti√≥n de Usuarios**:
   - Implementar confirmaci√≥n antes de eliminar usuarios
   - Usar paginaci√≥n para listas grandes de usuarios
   - Implementar filtros y b√∫squeda avanzada

2. **Asignaci√≥n de Roles**:
   - Validar que un ADMIN no pueda asignar rol SUPERADMIN
   - Implementar auditor√≠a de cambios de roles
   - Notificar a los usuarios cuando su rol cambie

3. **Monitoreo**:
   - Implementar logging de acciones administrativas
   - Monitorear intentos de acceso no autorizados
   - Implementar rate limiting para endpoints administrativos

### Ejemplo de Implementaci√≥n

```javascript
// Ejemplo de gesti√≥n de usuarios en frontend
class UserManager {
  constructor() {
    this.currentUser = null;
    this.users = [];
  }

  async getProfile() {
    const response = await fetch('/users/profile', {
      headers: {
        'Authorization': `Bearer ${this.getToken()}`
      }
    });
    
    const data = await response.json();
    if (data.success) {
      this.currentUser = data.data;
      return this.currentUser;
    }
    throw new Error(data.message);
  }

  async getAllUsers(limit = 10, offset = 0) {
    const response = await fetch(`/users?limit=${limit}&offset=${offset}`, {
      headers: {
        'Authorization': `Bearer ${this.getToken()}`
      }
    });
    
    const data = await response.json();
    if (data.success) {
      this.users = data.data;
      return this.users;
    }
    throw new Error(data.message);
  }

  async updateUser(userId, userData) {
    const response = await fetch(`/users/${userId}`, {
      method: 'PUT',
      headers: {
        'Authorization': `Bearer ${this.getToken()}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(userData)
    });
    
    const data = await response.json();
    if (data.success) {
      // Actualizar usuario en la lista local
      const index = this.users.findIndex(u => u.id === userId);
      if (index !== -1) {
        this.users[index] = data.data;
      }
      return data.data;
    }
    throw new Error(data.message);
  }

  async deleteUser(userId) {
    if (!confirm('¬øEst√° seguro de eliminar este usuario?')) {
      return;
    }
    
    const response = await fetch(`/users/${userId}`, {
      method: 'DELETE',
      headers: {
        'Authorization': `Bearer ${this.getToken()}`
      }
    });
    
    const data = await response.json();
    if (data.success) {
      // Eliminar usuario de la lista local
      this.users = this.users.filter(u => u.id !== userId);
      return data;
    }
    throw new Error(data.message);
  }

  getToken() {
    return localStorage.getItem('token');
  }

  hasPermission(action, resource) {
    if (!this.currentUser) return false;
    
    const permissions = {
      'superadmin': ['read', 'write', 'delete', 'manage'],
      'admin': ['read', 'write', 'delete'],
      'cliente': ['read']
    };
    
    return permissions[this.currentUser.role]?.includes(action) || false;
  }
}
```

---

## üîó Enlaces R√°pidos

| Operaci√≥n | Endpoint | Permisos | Descripci√≥n |
|-----------|----------|----------|-------------|
| **üë§ Ver Perfil** | `GET /users/profile` | Todos | Obtener perfil del usuario autenticado |
| **üë• Listar Usuarios** | `GET /users` | Admin/Superadmin | Listar todos los usuarios |
| **üîç Buscar Usuarios** | `GET /users/search/:term` | Admin/Superadmin | Buscar usuarios por t√©rmino |
| **‚úèÔ∏è Actualizar Usuario** | `PUT /users/:id` | Admin/Superadmin | Actualizar datos de usuario |
| **üîê Asignar Rol** | `PUT /users/:id/role` | Admin/Superadmin | üîí Asignar/cambiar rol de usuario con validaciones de seguridad |
| **üóëÔ∏è Eliminar Usuario** | `DELETE /users/:id` | Admin/Superadmin | Eliminar usuario del sistema |

---

### üìö Documentaci√≥n Relacionada

- **[üè† README Principal](../README.md)** - Informaci√≥n general del proyecto
- **[üìö Documentaci√≥n General](./README.md)** - Configuraci√≥n y convenciones
- **[üîê M√≥dulo de Autenticaci√≥n](./auth.md)** - Login y gesti√≥n de sesiones
- **[üõí M√≥dulo de Productos](./products.md)** - Cat√°logo e inventario

---

<div align="center">
  <strong>
    üë• **M√≥dulo de Usuarios**<br>
    Gesti√≥n de perfiles y control de acceso
  </strong>
</div>

<div align="center">
  <sub>
    [‚¨ÜÔ∏è Volver al inicio](#-m√≥dulo-de-usuarios) | 
    [üè† README Principal](../README.md) | 
    [üìö Documentaci√≥n General](./README.md) | 
    [üîê Autenticaci√≥n](./auth.md) | 
    [üõí Productos](./products.md)
  </sub>
</div>
